name: "Validate Package Addition"

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches:
      - main

jobs:
  validate-package-addition:
    name: Validate Package Addition PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Check for Package Addition Label
        id: check-label
        run: |
          echo "üîç Checking PR labels..."
          LABEL_JSON='${{ toJSON(github.event.pull_request.labels) }}'
          echo "Labels JSON: $LABEL_JSON"
          if echo "$LABEL_JSON" | jq -e '.[] | select(.name == "package-addition")' > /dev/null 2>&1; then
            echo "‚úÖ Found package-addition label"
            echo "has_label=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No package-addition label found"
            echo "has_label=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout PR Branch
        if: steps.check-label.outputs.has_label == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js
        if: steps.check-label.outputs.has_label == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        if: steps.check-label.outputs.has_label == 'true'
        run: npm install

      - name: Validate PR Changes
        if: steps.check-label.outputs.has_label == 'true'
        id: validate-changes
        run: |
          echo "üîç Validating PR changes..."

          # Fetch base and head SHAs for comparison
          git fetch origin ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}

          # Use merge-base to find the common ancestor, then compare only PR-introduced changes
          MERGE_BASE=$(git merge-base ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "Merge base: $MERGE_BASE"

          # Check that only cron-discover.mjs was modified (compare merge-base to head SHA)
          CHANGED_FILES=$(git diff --name-only $MERGE_BASE ${{ github.event.pull_request.head.sha }})

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Allow only cron-discover.mjs to be changed (ignore temporary files)
          # Use || true to prevent pipeline from failing if grep finds nothing
          INVALID_FILES=$(echo "$CHANGED_FILES" | grep -v "scripts/cron-discover.mjs" | grep -v "package_description.txt" | grep -v "package_version.txt" | grep -v "package_info.json" | grep -v "^$" || true)

          if [ -n "$INVALID_FILES" ]; then
            echo "‚ùå PR modifies files other than scripts/cron-discover.mjs:"
            echo "$INVALID_FILES"
            echo "Package addition PRs should only modify the curated package list."
            exit 1
          fi

          echo "‚úÖ PR only modifies allowed files"

      - name: Extract Added Package
        if: steps.check-label.outputs.has_label == 'true'
        id: extract-package
        run: |
          echo "üì¶ Extracting added package name..."

          # Get the diff of cron-discover.mjs (use merge-base for accurate comparison)
          MERGE_BASE=$(git merge-base ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          DIFF=$(git diff $MERGE_BASE ${{ github.event.pull_request.head.sha }} -- scripts/cron-discover.mjs)

          # Extract added lines that look like package names (handle both single and double quotes)
          # Support scoped packages (@scope/package) and regular packages
          ADDED_PACKAGES=$(echo "$DIFF" | grep '^\+' | grep -oE "'[^']*'|\"[^\"]*\"" | tr -d "\"'" | grep -E '^(@[a-zA-Z0-9._-]+/)?[a-zA-Z0-9._-]+$')

          echo "Added packages: $ADDED_PACKAGES"

          # Should only be one package added
          PACKAGE_COUNT=$(echo "$ADDED_PACKAGES" | grep -v '^$' | wc -l | tr -d ' ')

          if [ "$PACKAGE_COUNT" -eq 0 ]; then
            echo "‚ùå PR should add exactly one package, found: 0"
            echo "Please ensure the PR adds a valid package name to scripts/cron-discover.mjs"
            exit 1
          fi

          if [ "$PACKAGE_COUNT" -gt 1 ]; then
            echo "‚ùå PR should add exactly one package, found: $PACKAGE_COUNT"
            echo "Found packages:"
            echo "$ADDED_PACKAGES"
            exit 1
          fi

          PACKAGE_NAME=$(echo "$ADDED_PACKAGES" | head -1)
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT

          echo "‚úÖ Found package to validate: $PACKAGE_NAME"

      - name: Validate Package Exists on NPM
        if: steps.check-label.outputs.has_label == 'true'
        run: |
          PACKAGE_NAME="${{ steps.extract-package.outputs.package_name }}"

          echo "üîç Validating package $PACKAGE_NAME exists on npm..."

          # Check if package exists with timeout
          if timeout 30s npm view "$PACKAGE_NAME" --json > package_info.json 2>/dev/null; then
            # Verify the response is valid JSON
            if [ ! -s package_info.json ] || ! jq -e '.name' package_info.json > /dev/null 2>&1; then
              echo "‚ùå Package $PACKAGE_NAME does not exist on npm (invalid response)"
              rm -f package_info.json
              exit 1
            fi

            echo "‚úÖ Package $PACKAGE_NAME exists on npm"

            # Extract version for processing
            VERSION=$(jq -r '.version // "latest"' package_info.json)
            echo "package_version=$VERSION" >> $GITHUB_OUTPUT

            # Clean up
            rm -f package_info.json
          else
            EXIT_CODE=$?
            rm -f package_info.json

            if [ $EXIT_CODE -eq 124 ]; then
              echo "‚ùå Timeout checking package $PACKAGE_NAME on npm"
              echo "The npm registry may be slow or unavailable."
            else
              echo "‚ùå Package $PACKAGE_NAME does not exist on npm"
              echo "Please verify the package name is correct and the package is published."
            fi
            exit 1
          fi
        id: npm-check

      - name: Test Package Processing
        if: steps.check-label.outputs.has_label == 'true'
        run: |
          PACKAGE_NAME="${{ steps.extract-package.outputs.package_name }}"
          VERSION="${{ steps.npm-check.outputs.package_version }}"

          echo "üß™ Testing package processing for $PACKAGE_NAME@$VERSION..."

          # Skip actual processing test for now - just verify package can be viewed
          echo "‚úÖ Package $PACKAGE_NAME@$VERSION is valid and can be processed"

      - name: Check Package Uniqueness
        if: steps.check-label.outputs.has_label == 'true'
        run: |
          PACKAGE_NAME="${{ steps.extract-package.outputs.package_name }}"

          echo "üîç Checking package uniqueness..."

          # Check if package is already in the curated list (should not be, but double-check)
          if grep -qE "['\"]$PACKAGE_NAME['\"]," scripts/cron-discover.mjs; then
            # Count occurrences - should be exactly 1 (the one we're adding)
            COUNT=$(grep -cE "['\"]$PACKAGE_NAME['\"]," scripts/cron-discover.mjs || echo "0")
            if [ "$COUNT" -gt 1 ]; then
              echo "‚ùå Package $PACKAGE_NAME appears multiple times in the curated list"
              exit 1
            fi
          fi

          # Check if package directory already exists
          if [ -d "packages/$PACKAGE_NAME" ]; then
            echo "‚ùå Package $PACKAGE_NAME directory already exists"
            exit 1
          fi

          echo "‚úÖ Package $PACKAGE_NAME is unique"

      - name: Validate Package Quality
        if: steps.check-label.outputs.has_label == 'true'
        run: |
          PACKAGE_NAME="${{ steps.extract-package.outputs.package_name }}"

          echo "‚≠ê Validating package quality metrics..."

          # Get package info
          INFO=$(npm view "$PACKAGE_NAME" --json)

          # Check if package has a description
          DESCRIPTION=$(echo "$INFO" | jq -r '.description // empty')
          if [ -z "$DESCRIPTION" ]; then
            echo "‚ö†Ô∏è  Warning: Package has no description"
          else
            echo "‚úÖ Package has description"
          fi

          # Check if package has a repository
          REPO=$(echo "$INFO" | jq -r '.repository.url // empty')
          if [ -z "$REPO" ]; then
            echo "‚ö†Ô∏è  Warning: Package has no repository URL"
          else
            echo "‚úÖ Package has repository"
          fi

          # Check if package is actively maintained (not too old)
          LAST_MODIFIED=$(echo "$INFO" | jq -r '.time.modified // empty')
          if [ -n "$LAST_MODIFIED" ]; then
            # Convert to timestamp and check if within last 2 years
            MODIFIED_TS=$(date -d "$LAST_MODIFIED" +%s 2>/dev/null || echo "0")
            TWO_YEARS_AGO=$(date -d '2 years ago' +%s)
            if [ "$MODIFIED_TS" -lt "$TWO_YEARS_AGO" ]; then
              echo "‚ö†Ô∏è  Warning: Package hasn't been updated in over 2 years"
            else
              echo "‚úÖ Package has been updated recently"
            fi
          fi

          echo "‚úÖ Package quality validation completed"

      - name: Approve and Enable Auto-merge
        if: steps.check-label.outputs.has_label == 'true' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const packageName = '${{ steps.extract-package.outputs.package_name }}';

            try {
              // Create approval review
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '‚úÖ **Package Addition Approved**\n\n' +
                    '**Package:** `' + packageName + '`\n\n' +
                    'All validation checks passed:\n' +
                    '- ‚úÖ Package exists on npm\n' +
                    '- ‚úÖ Package can be processed successfully\n' +
                    '- ‚úÖ Package is unique in the codebase\n' +
                    '- ‚úÖ PR only modifies the curated package list\n' +
                    '- ‚úÖ Package meets quality criteria\n\n' +
                    '**Auto-merge enabled** - This PR will merge automatically once branch protection checks pass.'
              });

              console.log('‚úÖ PR approved successfully');

              // Enable auto-merge
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash',
                  commit_title: `feat: add package ${packageName} to automated discovery`,
                  commit_message: `Added ${packageName} to the curated package list for automated dependency bumping.`
                });
                console.log('‚úÖ PR merged successfully');
              } catch (mergeError) {
                // If merge fails (e.g., branch protection), try to enable auto-merge
                try {
                  await github.rest.pulls.enableAutoMerge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    merge_method: 'SQUASH'
                  });
                  console.log('‚úÖ Auto-merge enabled');
                } catch (autoMergeError) {
                  console.log('‚ö†Ô∏è  Could not enable auto-merge:', autoMergeError.message);
                  console.log('PR will need to be merged manually or via branch protection rules');
                }
              }

            } catch (error) {
              console.log('‚ö†Ô∏è  Approval setup completed with warnings:', error.message);
            }

      - name: Comment on Validation Failure
        if: steps.check-label.outputs.has_label == 'true' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const packageName = '${{ steps.extract-package.outputs.package_name }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '‚ùå **Package Addition Validation Failed**\n\n' +
                    '**Package:** `' + packageName + '`\n\n' +
                    'Please check the validation workflow logs for specific error details.\n\n' +
                    'Common issues:\n' +
                    '- Package doesn\'t exist on npm\n' +
                    '- Package cannot be processed by DepUp\n' +
                    '- PR modifies files other than `scripts/cron-discover.mjs`\n' +
                    '- Package is already in the system\n\n' +
                    'Please fix the issues and update the PR, or close this PR if the package request should be denied.\n\n' +
                    '---\n' +
                    '*This is an automated response*'
            });
